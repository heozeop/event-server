# Fluentd configuration for collecting service logs

# Input source for service application logs
<source>
  @type tail
  path /logs/**/*.log
  pos_file /fluentd/log/pos/app.pos
  tag service.*
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</source>

# Input source for NestJS logs from each service
<source>
  @type tail
  path /logs/gateway/gateway.log
  pos_file /fluentd/log/pos/gateway.pos
  tag nestjs.gateway
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</source>

<source>
  @type tail
  path /logs/auth/auth.log
  pos_file /fluentd/log/pos/auth.pos
  tag nestjs.auth
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</source>

<source>
  @type tail
  path /logs/event/event.log
  pos_file /fluentd/log/pos/event.pos
  tag nestjs.event
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</source>

# Input source for system logs
<source>
  @type tail
  path /var/log/syslog*,/var/log/messages*
  pos_file /fluentd/log/pos/system.pos
  tag system
  <parse>
    @type syslog
  </parse>
</source>

# Input source for Docker container logs
<source>
  @type tail
  path /var/lib/docker/containers/*/*-json.log
  pos_file /fluentd/log/pos/docker.pos
  tag docker
  <parse>
    @type json
  </parse>
</source>

# Tag router based on log path
<match service.**>
  @type rewrite_tag_filter
  <rule>
    key tag
    pattern /logs/gateway/.*
    tag service.gateway
  </rule>
  <rule>
    key tag
    pattern /logs/auth/.*
    tag service.auth
  </rule>
  <rule>
    key tag
    pattern /logs/event/.*
    tag service.event
  </rule>
</match>

# Structured logs formatting for service logs
<filter service.**>
  @type record_transformer
  <record>
    timestamp ${time}
    log_source ${tag}
  </record>
</filter>

# Structured logs formatting for nestjs logs
<filter nestjs.**>
  @type record_transformer
  <record>
    timestamp ${time}
    log_source ${tag}
  </record>
</filter>

# Structured logs formatting for system logs
<filter system>
  @type record_transformer
  <record>
    timestamp ${time}
    log_source ${tag}
  </record>
</filter>

# Structured logs formatting for docker logs
<filter docker>
  @type record_transformer
  <record>
    timestamp ${time}
    log_source ${tag}
  </record>
</filter>

# Output configuration for service logs
<match service.gateway>
  @type file
  path /fluentd/log/gateway/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

<match service.auth>
  @type file
  path /fluentd/log/auth/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

<match service.event>
  @type file
  path /fluentd/log/event/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

# Output configuration for NestJS logs
<match nestjs.gateway>
  @type file
  path /fluentd/log/nestjs/gateway/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

<match nestjs.auth>
  @type file
  path /fluentd/log/nestjs/auth/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

<match nestjs.event>
  @type file
  path /fluentd/log/nestjs/event/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

# Output configuration for system logs
<match system>
  @type file
  path /fluentd/log/system/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

# Output configuration for Docker logs
<match docker>
  @type file
  path /fluentd/log/docker/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

# Output for logs not matching any of the above filters
<match **>
  @type file
  path /fluentd/log/unmatched/%Y-%m-%d
  compress gzip
  <buffer tag,time>
    timekey 1d
    timekey_use_utc true
    timekey_wait 10m
    flush_mode interval
    flush_interval 1s
  </buffer>
  <format>
    @type json
  </format>
</match>

# Optional: Add monitoring for Fluentd
<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source> 
