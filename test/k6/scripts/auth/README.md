# Auth API Performance Tests

This directory contains performance tests for the Auth API endpoints.

## Available Tests

### 1. User Login Performance Test

Tests the login API endpoint with three different scenarios:

**Script**: `login-performance-test.ts`

**Performance Requirements**:
- Normal login scenario: 10 requests per second
- Wrong password scenario: 5 requests per second
- Non-existent user scenario: 2 requests per second
- Response time under 100ms for all scenarios

**Features**:
- Uses real user data from the prepared test database
- Tests both success and error scenarios
- Validates response structure and content
- Tracks success metrics for each scenario type

**Usage**:
```bash
# Run with default settings
pnpm k6 run dist/auth/login-performance-test.js
```

**Requirements**:
- Test data must be generated using the prepare scripts

### 2. User Registration Load Test

Tests the user registration endpoint at `POST /auth/users` with a load of 50 requests per second.

**Script**: `user-registration-load-test.ts`

**Usage**:
```bash
# Run with default settings
pnpm k6 run dist/auth/user-registration-load-test.js

# Run with custom options
pnpm k6 run --vus 20 --duration 30s dist/auth/user-registration-load-test.js
```

### 3. Current User Info Test

Tests the current user info endpoint at `GET /auth/me` with a load of 30 requests per second.

**Script**: `current-user-info-test.ts`

**Performance Requirements**:
- 30 requests per second
- Response time under 80ms

**Usage**:
```bash
# Run with default settings
pnpm k6 run dist/auth/current-user-info-test.js

# Run with a valid auth token
pnpm k6 run -e AUTH_TOKEN=your_valid_token dist/auth/current-user-info-test.js
```

**Notes**:
- This test requires a valid JWT token to access the protected endpoint
- You can provide a token via the AUTH_TOKEN environment variable
- Without a valid token, the test will fail with 401 Unauthorized errors

### 4. User Role Change Test

Tests the user role change endpoint at `PUT /auth/users/{userId}/roles` with two scenarios:

**Script**: `role-change-test.ts`

**Performance Requirements**:
- Single role addition: 3 requests per second
- Multiple role change: 2 requests per second
- Response time under 150ms

**Features**:
- Automatically authenticates with admin credentials
- Uses test data generated by the prepare scripts
- Randomly selects users from the database
- Tests both adding a single role and changing multiple roles

**Usage**:
```bash
# Run with default settings
pnpm k6 run dist/auth/role-change-test.js
```

**Requirements**:
- Test data must be generated using the prepare scripts
- Authentication service must be running and accessible

### 5. User Information Lookup Test

Tests the user information lookup endpoints with two different methods:

**Script**: `user-info-lookup-test.ts`

**Performance Requirements**:
- ID-based lookup: 15 requests per second
- Email-based lookup: 10 requests per second
- Response time under 100ms

**Features**:
- Tests both lookup methods using real user data from prepare scripts
- Automatically authenticates with admin credentials
- Randomly selects users for lookups
- Verifies consistency between request parameters and response data

**Usage**:
```bash
# Run with default settings
pnpm k6 run dist/auth/user-info-lookup-test.js
```

**Requirements**:
- Test data must be generated using the prepare scripts
- Authentication service must be running and accessible

### 6. Simple Login Performance Test

Tests the login API endpoint with a single scenario that matches the exact requirements:

**Script**: `simple-login-performance-test.ts`

**Performance Requirements**:
- 20 requests per second
- Response time under 200ms

**Features**:
- Uses real user data from the prepared test database
- Focuses only on successful login scenario
- Validates response structure and content
- Simple implementation that precisely follows the requirement specification

**Usage**:
```bash
# Run with default settings
pnpm k6 run dist/auth/simple-login-performance-test.js
```

**Requirements**:
- Test data must be generated using the prepare scripts

## Test Configuration

All tests use the following configuration:
- Constant arrival rate executor
- Duration specified in each test
- Thresholds based on performance requirements
- Custom metrics for success tracking

## User Registration Load Test

This test is designed to validate the system's ability to handle a high volume of user registrations:

- Simulates 50 new user registrations per second for a 5-minute duration
- Generates unique user data for each registration request
- Requires a response time of less than 300ms for 95% of requests
- Verifies failure rate remains below 1%

### Test Scenario Details

The test follows these steps for each virtual user:
1. Generate unique user registration data with random email
2. Submit a registration request to the `/api/auth/users` endpoint
3. Verify the response is successful and contains expected user data
4. Track successful registrations with a custom metric

### Running the Test

To run the user registration load test:

```bash
# First build the test
cd test/k6
pnpm build:k6

# Then run the test
k6 run dist/scripts/auth/user-registration-load-test.js
```

### Test Options

The test is configured with the following options:

- **Constant Arrival Rate**: 50 requests per second
- **Duration**: 5 minutes
- **Success Thresholds**:
  - 95% of requests should complete within 300ms
  - Maximum response time for successful requests should be under 500ms
  - At least 99% of requests should succeed with a 201 status code
  - Total successful registrations should exceed 14,000 over the test period

### Requirements

Make sure the Authentication service is running and accessible before starting the test.

### Test Data

This test generates unique user data on the fly, so there's no need to prepare test data beforehand. Each user will have:
- A unique email in the format `userXYZ@example.com`
- Password: `Password123!` 
